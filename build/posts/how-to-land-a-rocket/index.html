<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>My Website</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Roboto+Slab:wght@100..900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">  </head>
  <body>
    <header>
      <div class="header-content">
        <a class="site-title" href="/">Krzysztof Jóskowiak</a>
        <input id="ham-checkbox" class="ham-checkbox" type="checkbox">
        <label for="ham-checkbox" class="ham-icon">
          <div class="bars">
            <div class="bar top-bar"></div>
            <div class="bar mid-bar"></div>
            <div class="bar bot-bar"></div>
          </div>
        </label>
        <nav>
          <ul class="nav-menu">
              <li><a href="/">Home</a></li>
              <li><a href="/archive">Archive</a></li>
          </ul>
        </nav>
      </div>
    </header>
    <main>
      <div class="main-content">
        <article>
    <h1>How to land a rocket safely</h1>
    <p>During my time at the university I was trying to implement a controller with <a href="https://krpc.github.io/krpc/">kRPC</a> for Kerbal Space Program that would allow me to safely land a rocket, but would be a bit smarter than simple PID regulators. I've then come across an algorithm called G-FOLD and its open source implementations:</p>
<ul>
<li><a href="https://github.com/oyster-catcher/HopperGuidance">HopperGuidance</a></li>
<li><a href="https://github.com/jonnyhyman/G-FOLD-Python">G-FOLD-Python</a></li>
</ul>
<p>They both are based on the paper titled <em>"Lossless Convexification of Nonconvex Control
Bound and Pointing Constraints of the Soft
Landing Optimal Control Problem"</em>. In the first part of this series I'd like to introduce the algorithm and present a simple implementation using the Python API of <a href="https://web.casadi.org/">CasADi</a>, an <em>"open-source tool for nonlinear optimization and algorithmic differentiation."</em>. There are two consecutive optimization problems presented in this paper. The first one tries to land the rocket as close to the target landing point \(\mathbf{q}\) as possible, thus returning some optimal landing point \(\mathbf{d}^*_{P1}\) The second one tries to improve on the previous solution to use as little fuel as possible while landing not further from \(\mathbf{q}\) than \(\mathbf{d}^*_{P1}\).</p>
<h2>Engine characteristics</h2>
<p>The main characteristic of a rocket engine is specific impulse \(I_{sp}\). From wikipedia we read:</p>
<blockquote>
<p>Specific impulse, measured in seconds, effectively means how many seconds this propellant, when paired with this engine, can accelerate its own initial mass at 1 g. The longer it can accelerate its own mass, the more delta-V it delivers to the whole system.</p>
<p>In other words, given a particular engine and a mass of a particular propellant, specific impulse measures for how long a time that engine can exert a continuous force (thrust) until fully burning that mass of propellant. A given mass of a more energy-dense propellant can burn for a longer duration than some less energy-dense propellant made to exert the same force while burning in an engine. Different engine designs burning the same propellant may not be equally efficient at directing their propellant's energy into effective thrust. </p>
</blockquote>
<p>$$
I_{sp} = \frac{F \Delta t}{g_0 \Delta m}
$$</p>
<p>The \(\alpha\) parameter is defined w.r.t. the specific impulse 
$$
\alpha = \frac{1}{I_{sp}g_0}
$$</p>
<h2>The first optimization problem</h2>
<p>$$\begin{align}
    \min_{t_f, \mathbf{T}_c, \Gamma} \quad &amp; \| E\mathbf{r}(t_f) - \mathbf{q}\| \label{eq:p1min} \\
    \textrm{p.o.} \quad &amp; \mathbf{x}(t) \in \mathbf{X} \quad \forall t \in [0, t_f] \label{con1} \\
    &amp; 0 &lt; \rho_1 \leq \|\mathbf{T}_c\| \leq \rho_2, \quad \hat{\mathbf{n}}^T\mathbf{T}_c(t) \geq \|\mathbf{T}_c\| \cos{\theta} \label{con2} \\
    &amp; m(0) = m_0, \quad m(t_f) \geq m_0 - m_f &gt; 0 \label{con3} \\
    &amp; \mathbf{r}(0) = \mathbf{r_0}, \enspace \dot{\mathbf{r}}(0) = \dot{\mathbf{r}}_0 \label{con4} \\
    &amp; \mathbf{e}^T_1\mathbf{r}(t_f) = 0, \enspace \dot{\mathbf{r}}(tf) = \mathbf{0} \label{con5} \\
    &amp; \dot{\mathbf{x}}(t) = \mathbf{A}\mathbf{x}(t) + \mathbf{B}\left(\mathbf{g} + \frac{\mathbf{T}_c(t)}{m}\right) \quad \forall t \in [0, t_f] \label{con6} \\
    &amp; \dot{m}(t) = -\alpha \Gamma(t) \label{con7} \\
    &amp; \|\mathbf{T}_c(t)\| \leq \Gamma(t), \enspace 0 &lt; \rho_1 \leq \Gamma(t) \leq \rho_2 \label{con8} \\
    &amp; \hat{\mathbf{n}}^T\mathbf{T}_c(t) \geq \cos{\theta} \Gamma(t) \label{con9}
\end{align}$$</p>
<p>Helper vectors and matrices</p>
<p>$$\begin{align}
\mathbf{E} = \begin{bmatrix}
    0 &amp; 1 &amp; 0 \\
    0 &amp; 0 &amp; 1
\end{bmatrix}, \quad
\mathbf{A} = \begin{bmatrix}
    \mathbf{0} &amp; \mathbf{I} \\
    \mathbf{0} &amp; \mathbf{0}
\end{bmatrix}, \quad
\mathbf{B} = \begin{bmatrix}
    \mathbf{0} \\ \mathbf{I}
\end{bmatrix} \\
\mathbf{e}_1 = \begin{bmatrix}
    1 &amp; 0 &amp; 0
\end{bmatrix}^T, \quad
\mathbf{e}_2 = \begin{bmatrix}
    0 &amp; 1 &amp; 0
\end{bmatrix}^T
\end{align}$$</p>
<p>Definition of the set of possible positions</p>
<p>$$
\mathbf{X} = { (\mathbf{r}, \mathbf{\dot{r}}) \in \mathbb{R}^6 \, : \, \|\mathbf{\dot{r}} \| \leq V_{max}, \; \|E(\mathbf{r} - \mathbf{r}(t_f))\| - \mathbf{c}^T(\mathbf{r} - \mathbf{r}(t_f) \leq 0 }
$$</p>
<p>where \(\mathbf{c}\) defines a cone with it's point in \(\mathbf{r}(t_f)\), parametrized with the glide slope angle \(\gamma_{gs}\)</p>
<p>$$
\mathbf{c} \triangleq \frac{\mathbf{e}_1}{\tan{\gamma_{gs}}}, \quad \gamma_{gs} \in (0,\, \pi / 2).
$$</p>
<p>$$
\begin{align}
\min_{t_f, \mathbf{T}_c, \Gamma} \quad &amp; \int_0^{t_f} \Gamma(t)dt \\
&amp; \|E\mathbf{r}(t_f) - \mathbf{q}\| \leq \|\mathbf{d}^*_{P1} - \mathbf{q}\|
\end{align}
$$</p>
<p>Następujące podstawienie zostało wykonane przez autorów publikacji, aby pozbyć się nieliniowości w dynamice modelu spowodowanych przez \(\mathbf{T}_c/m\):</p>
<p>$$
\sigma \triangleq \frac{\Gamma}{m}, \quad \mathbf{u} \triangleq \frac{\mathbf{T}_c}{m}, \quad z \triangleq \ln{m}
$$</p>
<p>Mass loss dynamics</p>
<p>$$
\dot{z} = \frac{\dot{m}(t)}{m(t)} = -\alpha\sigma(t)
$$</p>
<p>$$
\begin{align}
    \|\mathbf{u}(t)\| &amp; \leq \sigma(t), \quad \mathbf{\hat{n}}^T\mathbf{u}(t) \geq \cos{\theta}\sigma(t) \quad \forall t \in [0, t_f] \nonumber \\
    \rho_1e^{-z(t)} &amp; \leq \sigma(t) \leq \rho_2e^{-z(t)} \quad \forall t \in [0, t_f] \label{eq:noncvx}
\end{align}
$$</p>
<p>$$
\begin{align}
    \sigma(t) &amp; \geq \rho_1e^{-z_0}\left[ 1 - (z(t) - z_0(t)) + \frac{(z(t) - z_0(t))^2}{2}\right] \quad \forall t \in [0, t_f] \\
    \sigma(t) &amp; \leq \rho_2e^{-z_0}[1 - (z(t) - z_0(t))] \quad \forall t \in [0, t_f]
\end{align}
$$</p>
<p>gdzie \(z_0(t) = \ln{m_0 - \alpha\rho_2 t}\), a \(m_0\) jest masą początkową pojazdu. Warto zauważyć, że z uwagi na obecność zmiennej \(z(t)^2\) dolne ograniczenie jest nieliniowe.</p>
<p>$$
\begin{align}
    \min_{T, \mathbf{u}, \sigma} \quad &amp; \int_0^{T} \sigma(t)dt \\
    \textrm{p.o.} \quad &amp; \mathbf{x}[k] \in \mathbf{X} \quad \forall k \in [0, N_t] \\
    &amp; \mathbf{x}[k] = \begin{bmatrix}
        \mathbf{r}[k] \\
        \mathbf{v}[k]
    \end{bmatrix} \\
    &amp; \mathbf{\dot{r}}[k] = T \cdot \mathbf{v}[k] \\
    &amp; \mathbf{\dot{v}}[k] = T \cdot ( \mathbf{u}[k] + \mathbf{g}) \\
    &amp; \dot{z} = - T \cdot \alpha \sigma(\tau) \\
    &amp; \rho_1e^{-z_0[k]}\left[ 1 - (z[k] - z_0[k])) + \frac{(z[k] - z_0[k])^2}{2}\right]  - \sigma[k] \leq 0 \\
    &amp; \sigma[k] - \rho_2e^{-z_0[k]}[1 - (z[k] - z_0[k])]\leq 0 \\
    &amp; z_0[k] = \ln{(m_0 - \alpha\rho_2 t)}, \quad t = kT / N_t \\
    &amp; z[0] = \ln{m_0}, \quad z[N_t] \geq \ln(m_0 - m_f), \quad m_0 - m_f &gt; 0 \\
    &amp; \mathbf{r}[0] = \mathbf{r}_0, \quad \dot{\mathbf{r}}[0] = \dot{\mathbf{r}}_0  \\
    &amp; \mathbf{r}[N_t][0:2] = [0, 0]^T, \enspace \dot{\mathbf{r}}[N_t] = [0, 0, 0]^T \\
    &amp; \|\mathbf{u}[k]\| - \sigma[k] \leq 0 \\
    &amp; \cos{\theta} \sigma[k] - \mathbf{u}[k][0] \leq 0 \\
    &amp; \mathbf{x}[k+1] - \mathbf{x}[k] - \Gamma_f(\mathbf{x}[k], \mathbf{u}[k], T) = \mathbf{0}
\end{align}
$$</p>
<p>Experiment 1.</p>
<p>$$
\begin{align}
    \theta \in &amp; {\pi, \, \pi/2, \, \pi/4 } \\
    m_f = &amp; 300 \\
    m_0 = &amp; 2000 \\
    \alpha = &amp; 5 \cdot 10^{-4} \\
    T_{max} = &amp; 24000 \\
    \rho_1 = &amp; 0.2 \cdot T_{max} \\
    \rho_2 = &amp; 0.8 \cdot T_{max} \\
    \mathbf{r}_0 &amp; = [2400,\, 450,\, -330]^T \\
    \mathbf{v}_0 &amp; = [-10,\, -40,\, 10]^T \\
    \mathbf{g} &amp; = [-3.71,\, 0,\, 0]^T 
\end{align}
$$</p>
<p>Experiment 2.</p>
<p>$$
\begin{align}
    \theta &amp; = 120^\circ \\
    \gamma_{gs} &amp; = 30^\circ \\
    m_f &amp; = 350 \\
    \mathbf{r}_0 &amp; = [2400,\, 3400,\, 0]^T \\
    \mathbf{v}_0 &amp; = [-40,\, 45,\, 0]^T 
\end{align}
$$</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">casadi</span>
<span class="kn">import</span> <span class="nn">casadi.casadi</span> <span class="k">as</span> <span class="nn">cs</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="n">T</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
    <span class="n">r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">nu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">nu_mag</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">t_grid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>


<span class="k">def</span> <span class="nf">run_problem</span><span class="p">(</span>
    <span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">gamma_gs</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">m_fuel</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">m_total</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">rho_1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">rho_2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">v_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">r0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">v0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">g</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">opti</span> <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">Opti</span><span class="p">()</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Initial states</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m_total</span><span class="p">)</span>
    <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">r</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">r0</span><span class="p">)</span>
    <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">v0</span><span class="p">)</span>
    <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">z0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">set_initial</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="o">*</span><span class="n">r0</span><span class="p">,</span> <span class="o">*</span><span class="n">v0</span><span class="p">,</span> <span class="n">z0</span><span class="p">])</span>

    <span class="n">opti</span><span class="o">.</span><span class="n">set_initial</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">N</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z0</span><span class="p">])</span>

    <span class="n">U</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">variable</span><span class="p">()</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">N</span>

    <span class="k">def</span> <span class="nf">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cs</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span>
            <span class="n">g</span> <span class="o">+</span> <span class="n">u</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span>
            <span class="o">-</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">X_next</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">dynamics</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">U</span><span class="p">[:,</span> <span class="n">k</span><span class="p">])</span>
        <span class="n">nu_k</span><span class="p">,</span> <span class="n">sigma_k</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">U</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">cost</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">sigma_k</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">X_next</span><span class="p">)</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">norm_2</span><span class="p">(</span><span class="n">nu_k</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">sigma_k</span><span class="p">)</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">set_initial</span><span class="p">(</span><span class="n">nu_k</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">set_initial</span><span class="p">(</span><span class="n">sigma_k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span> <span class="o">*</span> <span class="n">k</span> <span class="o">/</span> <span class="n">N</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m_total</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">rho_2</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">zk</span> <span class="o">=</span> <span class="n">X_next</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">rho_1</span> <span class="o">*</span> <span class="n">cs</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">z0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">zk</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">zk</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">sigma_k</span><span class="p">)</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">sigma_k</span> <span class="o">&lt;=</span> <span class="n">rho_2</span> <span class="o">*</span> <span class="n">cs</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">z0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">zk</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)))</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_k</span> <span class="o">&lt;=</span> <span class="n">nu_k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">norm_2</span><span class="p">(</span><span class="n">X_next</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">v_max</span><span class="p">)</span>

    <span class="c1"># Glide slope constraint</span>
    <span class="n">x_f</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">N</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">x_k</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">norm_2</span><span class="p">(</span><span class="n">x_k</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_f</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">x_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">gamma_gs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.</span>   
        <span class="p">)</span>

    <span class="c1"># Stop in 0, 0, 0</span>
    <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">X</span><span class="p">[:</span><span class="mi">6</span><span class="p">,</span> <span class="n">N</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span>

    <span class="n">opti</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
    <span class="n">opti</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>

    <span class="c1"># Duration</span>
    <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="mf">1.2</span> <span class="o">&lt;=</span> <span class="n">T</span><span class="p">)</span>
    <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">T</span> <span class="o">&lt;=</span> <span class="mf">70.</span><span class="p">)</span>
    <span class="n">opti</span><span class="o">.</span><span class="n">set_initial</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Solution</span><span class="p">(</span>
        <span class="n">T</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">T</span><span class="p">),</span>
        <span class="n">r</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">r</span><span class="p">),</span>
        <span class="n">v</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
        <span class="n">z</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">z</span><span class="p">),</span>
        <span class="n">nu</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">nu</span><span class="p">),</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
        <span class="n">nu_mag</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nu</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nu</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nu</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span>
        <span class="n">t_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </article>
      </div>
    </main>
    <footer>
      <div class="footer-content">
        <p>&copy; 2024 Krzysztof Jóskowiak</p>
      </div>
    </footer>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </body>
</html>